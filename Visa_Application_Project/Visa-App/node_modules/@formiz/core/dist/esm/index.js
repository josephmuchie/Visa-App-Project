import n,{useContext as e,useMemo as t,useState as r,useCallback as i,useEffect as u,useRef as o}from"react";import a from"prop-types";function c(n){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n})(n)}function f(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function l(){return(l=Object.assign||function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r])}return n}).apply(this,arguments)}function s(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function d(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?s(t,!0).forEach((function(e){f(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):s(t).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function p(n,e){if(null==n)return{};var t,r,i=function(n,e){if(null==n)return{};var t,r,i={},u=Object.keys(n);for(r=0;r<u.length;r++)t=u[r],e.indexOf(t)>=0||(i[t]=n[t]);return i}(n,e);if(Object.getOwnPropertySymbols){var u=Object.getOwnPropertySymbols(n);for(r=0;r<u.length;r++)t=u[r],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(i[t]=n[t])}return i}function m(n,e){return b(n)||function(n,e){if(!(Symbol.iterator in Object(n)||"[object Arguments]"===Object.prototype.toString.call(n)))return;var t=[],r=!0,i=!1,u=void 0;try{for(var o,a=n[Symbol.iterator]();!(r=(o=a.next()).done)&&(t.push(o.value),!e||t.length!==e);r=!0);}catch(n){i=!0,u=n}finally{try{r||null==a.return||a.return()}finally{if(i)throw u}}return t}(n,e)||S()}function v(n){return function(n){if(Array.isArray(n)){for(var e=0,t=new Array(n.length);e<n.length;e++)t[e]=n[e];return t}}(n)||y(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function b(n){if(Array.isArray(n))return n}function y(n){if(Symbol.iterator in Object(n)||"[object Arguments]"===Object.prototype.toString.call(n))return Array.from(n)}function S(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function h(n){var e=function(n,e){if("object"!=typeof n||null===n)return n;var t=n[Symbol.toPrimitive];if(void 0!==t){var r=t.call(n,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(n)}(n,"string");return"symbol"==typeof e?e:String(e)}var g=function(n){return n&&"object"===c(n)&&n.constructor===Object},O=function(n){return Object.keys(n).reduce((function(n,e){return V(e,n)}),n)},V=function(n,e){if(n.indexOf(".")<0&&n.indexOf("[")<0)return e;var t,r=e[n],i=e||{},u=(i[n],p(i,[n].map(h))),o=n.split("."),a=b(t=o)||y(t)||S(),c=a[0],l=a.slice(1);if(c.match(/\[([0-9]*)\]$/g)){var s=m(c.split(/(\[|\])/g),3),v=s[0],V=s[2],E=e[v]||[];if(l.length){var _=d({},e[v]&&g(e[v][V])?e[v][V]:{},f({},l.join("."),r));E[V]=O(_)}else E[V]=r;return d({},u,f({},v,E))}var j=d({},g(e[c])?e[c]:{},f({},l.join("."),r));return d({},u,f({},c,O(j)))},E=function(n){var e=(n||[]).filter((function(n){return n.isEnabled})).reduce((function(n,e){return d({},n,f({},e.name,e.value))}),{});return O(e)},_=function(n,e){return(e||[]).filter((function(n){return n.isEnabled})).filter((function(e){return e.step===n}))},j=function(n,e){var t=function(n,e){return(e||[]).find((function(e){return e.name===n}))}(n,e);if(!t)return[];var r=(t.validations||[]).map((function(n){return n.rule&&!n.rule(t.value)?n.message:"___FIELD_IS_VALID___"})).filter((function(n){return"___FIELD_IS_VALID___"!==n}));return t.externalError?[t.externalError].concat(v(r)):r},w=function(n){return(n||[]).filter((function(n){return n.isEnabled}))},P=function(n){return(n||[]).sort((function(n,e){return n.index-e.index})).sort((function(n,e){return n.order-e.order})).map((function(n,e){return d({},n,{index:e})}))},x=function(n){return n.navigatedStepName||n.initialStepName},I=function(n,e){return(e||[]).filter((function(n){return n.isEnabled})).findIndex((function(e){return e.name===n}))||0},T=function(n,e){var t=w(e);return P(t).find((function(e){return e.name===n}))||{}},N=function(n){return"formiz-".concat(n,"-id-").concat(Math.random().toString(36).substr(2,9))},A=n.createContext(),F=function(){return e(A)},z=function(e){var o=e.children,a=e.onStateChange,c=e.onSubmit,f=e.onValidSubmit,l=e.onInvalidSubmit,s=t((function(){return N("form")}),[]),d=m(r({id:s,resetKey:1,isValid:!0,isSubmitted:!1,initialStepName:null,navigatedStepName:null,steps:[],fields:[]}),2),p=d[0],v=d[1],b=i((function(n){v((function(e){return n(e)}))}),[]);return u((function(){a(p)}),[p]),n.createElement(A.Provider,{value:{state:p,dispatch:b,onSubmit:c,onValidSubmit:f,onInvalidSubmit:l}},o)};z.propTypes={children:a.node.isRequired,onStateChange:a.func,onSubmit:a.func,onValidSubmit:a.func,onInvalidSubmit:a.func},z.defaultProps={onStateChange:function(){},onSubmit:function(){},onValidSubmit:function(){},onInvalidSubmit:function(){}};var C=function(){return function(n){var e=(n.fields||[]).map((function(e){return d({},e,{errors:j(e.name,n.fields)})})),t=e.filter((function(n){return n.isEnabled})).every((function(n){return!n.errors.length})),r=(n.steps||[]).map((function(n){return d({},n,{isValid:_(n.name,e).every((function(n){return!n.errors.length}))})}));return d({},n,{fields:e,steps:r,isValid:t})}},D=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};return function(r){var i=(r.steps||[]).map((function(n){return d({},n,{isSubmitted:!0})})),u=E(r.fields);n(u);var o=d({},r,{steps:i,isSubmitted:!0});return(o=C()(o)).isValid?e(u):t(u),o}},K=function(n){return function(e){var t=e.steps,r=w(t).find((function(e){return e.name===n}));if(!r||!r.name)return e;var i=d({},e,{navigatedStepName:r.name});return i=C()(i)}},k=function(n){return function(e){var t=e.steps,r=w(t)[n]||{};return K(r.name)(e)}},q=function(){return function(n){var e=n.steps,t=w(e).length,r=x(n),i=I(r,e),u=t>0?i+1:0;return k(u=u>t-1?i:u)(n)}},L=function(){return function(n){var e=n.steps,t=x(n),r=I(t,e)-1;return k(r=r<0?0:r)(n)}},$=function(n,e){return function(t){var r=t.fields.find((function(e){return e.id===n}));if(!r)return t;var i=t.fields.filter((function(e){return e.id!==n})),u=(r.externalError,p(r,["externalError"])),o=[].concat(v(i),[d({},u,{value:e,isPristine:!1})]),a=d({},t,{fields:o});return a=C()(a)}},J={id:null,submit:function(){},isValid:!0,isSubmitted:!1,values:{},invalidateFields:function(){},reset:function(){},resetKey:0,currentStep:{},steps:[],isStepValid:!0,isStepSubmitted:!1,isFirstStep:!0,isLastStep:!0,submitStep:function(){},getFieldStepName:function(){},nextStep:function(){},prevStep:function(){},goToStep:function(){}},M=function(){var n=F();if(!n)return null;var e=n.state,t=n.dispatch,r=n.onSubmit,i=n.onValidSubmit,u=n.onInvalidSubmit,o=e.id,a=e.fields,c=e.isValid,f=e.isSubmitted,l=e.steps,s=e.resetKey,m=E(a),b=function(n){return{name:n.name,label:n.label,isValid:n.isValid,isVisited:n.isVisited,isSubmitted:n.isSubmitted,index:n.index}},y=w(l),S=y.length,h=x(e),g=T(h,y),O=I(h,y);return{id:o,submit:function(n){n&&n.preventDefault(),t(D(r,i,u))},isValid:c,isSubmitted:f,values:m,invalidateFields:function(n){t(function(n){return function(e){var t=e.fields.map((function(e){var t=n[e.name];return t?d({},e,{externalError:t}):e})),r=d({},e,{fields:t});return r=C()(r)}}(n))},reset:function(){t((function(n){var e=(n.fields||[]).map((function(n){n.externalError;var e=p(n,["externalError"]);return d({},e,{isPristine:!0,value:e.defaultValue})})),t=(n.steps||[]).map((function(n){return d({},n,{isSubmitted:!1,isVisited:!1})})),r=d({},n,{fields:e,steps:t,isSubmitted:!1,navigatedStepName:n.initialStepName,resetKey:n.resetKey+1});return r=C()(r)}))},resetKey:s,currentStep:b(g),steps:y.map(b),isStepValid:g.isValid,isStepSubmitted:g.isSubmitted,isFirstStep:0===O,isLastStep:O===S-1,submitStep:function(n){n&&n.preventDefault(),t(function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){};return function(i){var u=i.steps.find((function(e){return e.name===n}))||{},o=i.steps.filter((function(e){return e.name!==n})),a=P([].concat(v(o),[d({},u,{isSubmitted:!0})])),c=d({},i,{steps:a});return u.isValid?(c.navigatedStepName===(c=q()(c)).navigatedStepName&&(c=D(e,t,r)(c)),c):c}}(h,r,i,u))},getFieldStepName:function(n){return function(n,e){var t=e.find((function(e){return e.name===n}));if(t&&t.isEnabled)return t.step}(n,a)},nextStep:function(){t(q())},prevStep:function(){t(L())},goToStep:function(n){t(K(n))}}},R={children:a.node,autoForm:a.bool,onValid:a.func,onInvalid:a.func,onChange:a.func,connect:a.shape({__connect__:a.func})},B={children:"",autoForm:!1,onValid:function(){},onInvalid:function(){},onChange:function(){},connect:{__connect__:function(){}}},G=function(e){var t=e.children,r=e.autoForm,i=e.onValid,o=e.onInvalid,a=e.onChange,c=e.connect,f=F().dispatch,l=M();return a(l.values),l.isValid?i():o(),u((function(){c.__connect__(l)}),[f,JSON.stringify(c.__connect__),JSON.stringify(l)]),r?n.createElement("form",{noValidate:!0,onSubmit:l.submit},t):t};G.propTypes=R,G.defaultProps=B;var H=new Error("A <FormizStep> always needs a `name` attribute."),Q={as:a.oneOfType([a.func,a.string,a.shape({$$typeof:a.symbol,render:a.func}),a.arrayOf(a.oneOfType([a.func,a.string,a.shape({$$typeof:a.symbol,render:a.func})]))]),children:a.oneOfType([a.node,a.func]),isEnabled:a.bool,name:a.string.isRequired,label:a.node,order:a.number,style:a.oneOfType([a.object,a.array])},U={as:"div",children:"",isEnabled:!0,label:"",order:0,style:{}},W=function(e){var t=e.as,r=e.children,i=e.isEnabled,o=e.name,a=e.label,c=e.order,f=e.style,s=p(e,["as","children","isEnabled","name","label","order","style"]);if(!o)throw H;var m=F().dispatch,b=M().currentStep,y=b.name===o;return u((function(){b.name&&!b.isVisited&&y&&m(function(n){return function(e){var t=e.steps.find((function(e){return e.name===n}))||{},r=e.steps.filter((function(e){return e.name!==n})),i=P([].concat(v(r),[d({},t,{isVisited:!0})]));return d({},e,{steps:i})}}(b.name))})),u((function(){y&&!i&&m(L())}),[i,y]),u((function(){return m(function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=e.order,r=void 0===t?0:t,i=e.label,u=void 0===i?"":i,o=e.isEnabled,a=void 0===o||o;return function(e){var t=e.steps.find((function(e){return e.name===n}))||{},i=e.steps.filter((function(e){return e.name!==n})),o=P([].concat(v(i),[d({},t,{name:n,label:u,order:r,isValid:!0,isVisited:!1,isSubmitted:!1,isEnabled:a})])),c=d({},e,{steps:o,initialStepName:o.length?o[0].name:null});return c=C()(c)}}(o,{order:c})),function(){m(function(n){return function(e){var t=e.steps.filter((function(e){return e.name!==n})),r=d({},e,{steps:P(t)});return r=C()(r)}}(o))}}),[o,c]),u((function(){m(function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=e.label,r=e.isEnabled;return function(e){var i=e.steps.find((function(e){return e.name===n}))||{},u=e.steps.filter((function(e){return e.name!==n})),o=P([].concat(v(u),[d({},i,{label:t,isEnabled:r})]));return d({},e,{steps:o})}}(o,{label:a,isEnabled:!!i}))}),[i,a]),"function"==typeof r?r({isActive:y}):n.createElement(t,l({style:d({},f,{display:y?null:"none"})},s),i&&r)};W.propTypes=Q,W.defaultProps=U;var X=n.createContext(),Y=function(e){var t=e.children,r=e.name;return n.createElement(X.Provider,{value:r},t)};Y.propTypes={children:a.node.isRequired,name:a.string},Y.defaultProps={name:null};var Z=function(){var n=m(r(J),2),e=n[0],t=n[1],i=M();if(i)return i;return d({},e,{__connect__:function(n){t(n)}})};function nn(n,e,t,r){var i,u=null==(i=r)||"number"==typeof i||"boolean"==typeof i?r:t(r),o=e.get(u);return void 0===o&&(o=n.call(this,r),e.set(u,o)),o}function en(n,e,t){var r=Array.prototype.slice.call(arguments,3),i=t(r),u=e.get(i);return void 0===u&&(u=n.apply(this,r),e.set(i,u)),u}function tn(n,e,t,r,i){return t.bind(e,n,r,i)}function rn(n,e){return tn(n,this,1===n.length?nn:en,e.cache.create(),e.serializer)}function un(){return JSON.stringify(arguments)}function on(){this.cache=Object.create(null)}on.prototype.has=function(n){return n in this.cache},on.prototype.get=function(n){return this.cache[n]},on.prototype.set=function(n,e){this.cache[n]=e};var an={create:function(){return new on}},cn=function(n,e){var t=e&&e.cache?e.cache:an,r=e&&e.serializer?e.serializer:un;return(e&&e.strategy?e.strategy:rn)(n,{cache:t,serializer:r})},fn={variadic:function(n,e){return tn(n,this,en,e.cache.create(),e.serializer)},monadic:function(n,e){return tn(n,this,nn,e.cache.create(),e.serializer)}};cn.strategies=fn;var ln=new Error("A Formiz field always needs to be in a `<Formiz>` component."),sn=new Error("A Formiz field always needs a `name` attribute."),dn={debounce:a.number,defaultValue:a.any,formatValue:a.func,required:a.oneOfType([a.bool,a.node]),keepValue:a.bool,name:a.string,onChange:a.func,validations:a.arrayOf(a.shape({rule:a.func,message:a.node}))},pn={debounce:100,defaultValue:null,formatValue:function(n){return n},required:!1,keepValue:!1,onChange:function(){},validations:[]},mn=function(n){return n||""===n?{rule:function(n){return!!n||0===n},message:!0!==n?n:""}:{}},vn=function(n,e){var t=[mn(n)];return[].concat(t,v(e)).filter((function(n){return n.rule})).map((function(n){return d({},n,{rule:cn(n.rule)})}))},bn=function(n){var i=n.debounce,a=void 0===i?100:i,c=n.defaultValue,f=n.formatValue,l=void 0===f?function(n){return n}:f,s=n.required,p=n.keepValue,b=n.name,y=n.onChange,S=n.validations,h=void 0===S?[]:S,g=t((function(){return N("field")}),[]);if(!b)throw sn;var O=F(),V=e(X);if(!O)throw ln;var E=O.state,_=O.dispatch,j=E.fields.find((function(n){return n.name===b}))||{},w=(j.errors||[]).filter((function(n){return!!n})),P=T(V,E.steps),x=P.name?P.isSubmitted:E.isSubmitted,I=m(r(j.value||c),2),A=I[0],z=I[1],D=o(a);D.current=a;var K=o();K.current=c;var k=o();k.current=A;var q=o();q.current=p;var L=o();L.current=l;var J=o(!0);return u((function(){return _(function(n,e){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=t.value,i=void 0===r?null:r,u=t.step,o=void 0===u?null:u,a=t.validations,c=void 0===a?[]:a;return function(t){var r=t.fields.find((function(n){return n.name===e}))||{},u=t.fields.filter((function(n){return n.name!==e})),a=[].concat(v(u),[d({},r,{id:n,name:e,value:r.value||i,defaultValue:i,isEnabled:!0,isPristine:!0,step:o,validations:c,errors:[]})]),f=d({},t,{fields:a});return f=C()(f)}}(g,b,{value:k.current||K.current,step:V,validations:vn(s,h)})),function(){var n,e;_((n=g,e=q.current,function(t){var r=t.fields.find((function(e){return e.id===n}));if(!r)return t;var i=t.fields.filter((function(e){return e.id!==n})),u=e?[].concat(v(i),[d({},r,{isEnabled:!1})]):i,o=d({},t,{fields:u});return o=C()(o)}))}}),[g,b,V]),u((function(){q.current||z(K.current)}),[E.resetKey]),u((function(){if(J.current)return function(){};var n=L.current(A);if(!D.current)return _($(g,n)),function(){};var e=setTimeout((function(){_($(g,n))}),D.current);return function(){clearTimeout(e)}}),[JSON.stringify(A),g]),u((function(){J.current||_(function(n,e){return function(t){var r=t.fields.find((function(e){return e.id===n}));if(!r)return t;var i=t.fields.filter((function(e){return e.id!==n})),u=[].concat(v(i),[d({},r,{validations:e})]),o=d({},t,{fields:u});return o=C()(o)}}(g,vn(s,h)))}),[g,s].concat(v(h.reduce((function(n,e){return[].concat(v(n),v(e.deps||[]),[e.message])}),[])))),u((function(){J.current=!1}),[]),{id:g,resetKey:E.resetKey,value:A||"",valueDebounced:j.value||c||"",errorMessages:w,errorMessage:w[0],isValid:!j.errors||!j.errors.length,isPristine:!!j.isPristine,isSubmitted:x,setValue:function(n){z(n),y&&y(L.current(n))}}},yn=function(e){return n.createElement(z,e,n.createElement(G,e))};yn.propTypes=d({},R,{onSubmit:a.func,onValidSubmit:a.func,onInvalidSubmit:a.func}),yn.defaultProps=d({},B,{onSubmit:function(){},onValidSubmit:function(){},onInvalidSubmit:function(){}});var Sn=function(e){var t=e.name,r=e.order,i=p(e,["name","order"]);return n.createElement(Y,{name:t},n.createElement(W,l({},i,{name:t,order:r})))};Sn.propTypes=Q,Sn.defaultProps=U;export{yn as Formiz,Sn as FormizStep,pn as fieldDefaultProps,dn as fieldPropTypes,bn as useField,Z as useForm};
//# sourceMappingURL=index.js.map
